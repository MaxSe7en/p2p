<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trade Details - P2P Escrow</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    h1, h2 {
      color: #333;
    }
    .nav-links {
      margin: 20px 0;
    }
    .nav-links a {
      color: #007bff;
      text-decoration: none;
      margin-right: 15px;
    }
    .nav-links a:hover {
      text-decoration: underline;
    }
    #trade-details {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-bottom: 20px;
    }
    .detail-row {
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
    }
    .detail-label {
      font-weight: bold;
      color: #555;
    }
    .status {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 3px;
      font-weight: bold;
    }
    .status.open { background: #28a745; color: white; }
    .status.in_progress { background: #ffc107; color: black; }
    .status.completed { background: #6c757d; color: white; }
    .status.cancelled { background: #dc3545; color: white; }
    .actions {
      margin: 20px 0;
    }
    button {
      padding: 10px 20px;
      margin-right: 10px;
      margin-bottom: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary {
      background: #007bff;
      color: white;
    }
    .btn-primary:hover {
      background: #0056b3;
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-success:hover {
      background: #218838;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #trade-status {
      margin-top: 15px;
      padding: 15px;
      border-radius: 5px;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .loading {
      color: #666;
      font-style: italic;
    }
    .info-note {
      background: #d1ecf1;
      color: #0c5460;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>Trade Details</h1>
  
  <div class="nav-links">
    <a href="index.html">‚Üê Back to Trades List</a>
    <a href="chats.html">üí¨ My Chats</a>
    <a href="#" onclick="loadTrade(); return false;">Refresh</a>
    <span id="user-info" style="float: right; color: #666;"></span>
  </div>

  <div id="trade-details">
    <p class="loading">Loading trade details...</p>
  </div>

  <div id="role-note"></div>

  <h2>Actions</h2>
  <div class="actions">
    
    <button class="btn-primary" onclick="buyTrade()" id="buy-btn">
      Buy This Trade
    </button>
    
    <button class="btn-success" onclick="releaseTrade()" id="release-btn">
      Release Escrow
    </button>
    
    <button class="btn-danger" onclick="cancelTrade()" id="cancel-btn">
      Cancel Trade
    </button>
    
    <button class="btn-primary" onclick="openChat()">
      Open Chat
    </button>
  </div>

  <div id="trade-status"></div>

  <script src="assets/js/notification-system.js"></script>
  <script>
    const API_BASE = 'http://localhost:8000';
    const urlParams = new URLSearchParams(window.location.search);
    const tradeId = urlParams.get('trade');
    let currentTrade = null;

    // Check if user is logged in
    const userId = parseInt(localStorage.getItem('user_id'));
    const username = localStorage.getItem('username');

    if (!userId) {
      window.location.href = 'login.html';
    }

    // Display user info
    const userInfo = document.getElementById('user-info');
    if (userInfo && username) {
      userInfo.innerHTML = `Logged in as: <strong>${username}</strong>`;
    }

    if (!tradeId) {
      document.body.innerHTML = '<h1>Error: No trade ID provided</h1><a href="index.html">Go back</a>';
    }

    async function loadTrade() {
      const container = document.getElementById('trade-details');
      container.innerHTML = '<p class="loading">Loading trade details...</p>';
      
      try {
        const response = await fetch(`${API_BASE}/trades/${tradeId}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        currentTrade = await response.json();
        
        if (!currentTrade) {
          throw new Error('Trade not found');
        }
        
        displayTrade(currentTrade);
        updateButtonStates(currentTrade);
        
      } catch (error) {
        console.error('Error loading trade:', error);
        container.innerHTML = `
          <div class="error">
            <strong>Error loading trade:</strong> ${error.message}
          </div>
        `;
      }
    }

    function displayTrade(trade) {
      const container = document.getElementById('trade-details');
      container.innerHTML = `
        <div class="detail-row">
          <span class="detail-label">Trade ID:</span>
          <span>${trade.id}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Asset:</span>
          <span><strong>${trade.asset}</strong></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Amount:</span>
          <span>${trade.amount}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status:</span>
          <span class="status ${trade.status}">${trade.status.toUpperCase()}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Seller:</span>
          <span>${trade.seller_name}${trade.seller_id === userId ? ' (You)' : ''}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Buyer:</span>
          <span>${trade.buyer_name ? trade.buyer_name + (trade.buyer_id === userId ? ' (You)' : '') : 'None yet'}</span>
        </div>
      `;
    }

    function updateButtonStates(trade) {
      const buyBtn = document.getElementById('buy-btn');
      const releaseBtn = document.getElementById('release-btn');
      const cancelBtn = document.getElementById('cancel-btn');
      const roleNote = document.getElementById('role-note');

      const isSeller = trade.seller_id === userId;
      const isBuyer = trade.buyer_id === userId;

      // Clear role note
      roleNote.innerHTML = '';

      if (isSeller) {
        // Seller cannot buy their own trade
        buyBtn.disabled = true;
        buyBtn.style.display = 'none';
        
        // Seller can release only when in_progress
        releaseBtn.disabled = trade.status !== 'in_progress';
        
        // Seller can cancel open or in_progress trades
        cancelBtn.disabled = !(trade.status === 'open' || trade.status === 'in_progress');
        
        roleNote.innerHTML = '<div class="info-note"><strong>You are the seller</strong> - You can release funds when buyer confirms payment, or cancel the trade.</div>';
        
      } else if (isBuyer) {
        // Buyer cannot buy again
        buyBtn.disabled = true;
        buyBtn.style.display = 'none';
        
        // Buyer cannot release
        releaseBtn.disabled = true;
        
        // Buyer can cancel if in_progress
        cancelBtn.disabled = trade.status !== 'in_progress';
        
        roleNote.innerHTML = '<div class="info-note"><strong>You are the buyer</strong> - Complete payment and notify seller to release escrow.</div>';
        
      } else {
        // Not involved in trade
        buyBtn.disabled = trade.status !== 'open';
        
        // Cannot release or cancel
        releaseBtn.disabled = true;
        cancelBtn.disabled = true;
        
        if (trade.status === 'open') {
          roleNote.innerHTML = '<div class="info-note">This trade is available. Click "Buy This Trade" to initiate.</div>';
        }
      }
    }

    async function buyTrade() {
      if (!confirm('Do you want to buy this trade?')) {
        return;
      }
      await performAction('buy', { buyer_id: userId });
    }

    async function releaseTrade() {
      if (!confirm('Have you received payment? Releasing escrow will complete the trade and cannot be undone.')) {
        return;
      }
      await performAction('release', { seller_id: userId });
    }

    async function cancelTrade() {
      if (!confirm('Are you sure you want to cancel this trade?')) {
        return;
      }

      await performAction('cancel', { user_id: userId });
    }

    async function performAction(action, data) {
      const statusDiv = document.getElementById('trade-status');
      statusDiv.innerHTML = '<p class="loading">Processing...</p>';

      try {
        const response = await fetch(`${API_BASE}/trades/${tradeId}/${action}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.error) {
          throw new Error(result.error);
        }

        statusDiv.innerHTML = `<div class="success">${result.message}</div>`;
        
        // Reload trade details
        setTimeout(() => loadTrade(), 1000);

      } catch (error) {
        console.error(`Error performing ${action}:`, error);
        statusDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }

    function openChat() {
      window.location.href = `chat.html?trade=${tradeId}`;
    }

    // Load trade on page load
    loadTrade();
  </script>
</body>
</html>